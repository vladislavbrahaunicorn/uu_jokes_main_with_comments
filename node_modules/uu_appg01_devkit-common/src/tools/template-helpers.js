const fs = require("fs-extra");
const util = require("util");
const fs_writeFile = util.promisify(fs.writeFile);
const fs_readFile = util.promisify(fs.readFile);
const fs_copyFile = util.promisify(fs.copyFile);
const StringUtil = require("./string-util");

async function processFile(fullPath, destFile, context) {
  let shouldEvalExpressions = fullPath.match(/(\.json|\.html|\.js|\.md|\.snap|\.less|LICENSE)$/);
  if ( shouldEvalExpressions ) {
    // let contents = await fs_readFile(fullPath, "utf-8");
    // let evaledContents = StringUtil.evalExpressions(contents, context, fullPath);
    let evaledContents = await evalTemplate(fullPath, context);
    await fs_writeFile(destFile, evaledContents, "utf-8");
  } else {
    await fs_copyFile(fullPath, destFile);
  }
}

async function evalTemplate(fullPath, context) {
  let contents = await fs_readFile(fullPath, "utf-8");
  return StringUtil.evalExpressions(contents, context, fullPath);
}

module.exports = {
  processFile,
  evalTemplate
};
