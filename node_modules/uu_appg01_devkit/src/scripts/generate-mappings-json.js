const fs = require("fs");
const path = require("path");

const paths = require("../config/paths.js");

module.exports = class GenerateMappingsJson {

  constructor(config) {
    this.config = config;
    this.debug = this.config.get("debug");
  }

  process() {
    let MappingsLoader;
    try {
      MappingsLoader = require("uu_appg01_core-appserver").MappingsLoader;
    } catch (e) {
      if (this.debug) {
        console.log("Warning: Library uu_appg01_core-appserver not found. Mappings.json will not be merged.", e);
      }
      return;
    }

    if (!MappingsLoader) {
      if (this.debug) {
        console.log("Warning: You are not using latest version of the uu_appg01_core-appserver. Mappings.json will not be merged.");
      }
      return;
    }

    console.log("Merging mappings.json of the application and libraries...");

    try {
      const { Config } = require("uu_appg01_core-utils");
      Config.set("server_root", process.cwd());
      const mergerdMappings = MappingsLoader.load().data;

      Object.keys(mergerdMappings).forEach(product => {
        for (let [useCaseName, useCaseProps] of Object.entries(mergerdMappings[product].useCaseMap)) {
          const source = useCaseProps.source;
          if (source.includes("node_modules")) {
            const libraryName = path.normalize(source).split("node_modules" + path.sep).pop().split(path.sep)[0];
            useCaseProps.realization = `${libraryName}:${useCaseProps.realization}`;
          }
          delete useCaseProps.source;
        }
      });

      if (!fs.existsSync(paths.buildDir)) {
        fs.mkdirSync(paths.buildDir);
      }
      let mappingsPath = path.join(paths.buildDir, "mappings.json");
      fs.writeFileSync(mappingsPath, JSON.stringify(mergerdMappings, null, 2), "utf-8");

      console.log("> Merged mappings.json saved to: " + mappingsPath);
    } catch (e) {
      if (this.debug) {
        console.log("> Unable to merge mappings.json.", e);
      } else {
        console.log("> Unable to merge mappings.json."
          + "Merged configuration is for informational purposes only and has no effect on the build process. For more information about the error run this task with -- --debug parameter.");
      }
    }
  }

};
