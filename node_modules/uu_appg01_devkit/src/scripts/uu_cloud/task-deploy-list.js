const fs = require("fs");
const CmdHelper = require("uu_appg01_devkit-common/src/scripts/misc/cmd-helper.js");
const AppClient = require("uu_appg01_devkit-common/src/scripts/misc/app-client.js");

const DEPLOY_LIST_URI = "uu-c3/AppDeployment/getAppDeploymentList/exec";

const HEADERS = {
  "Accept": "application/json",
  "Content-type": "application/json"
};

class uuCloudDeployTask {

  constructor(cloudConfig) {
    this.config = cloudConfig.uuDeployListConfig();
    this.appClient = new AppClient(this.config.oidcToken);
  }

  async process() {
    let deployList = await this._getExport();
    this._saveList(deployList);
  }

  async _getExport() {
    console.log("Getting list of applications deployed in resource pool " + this.config.resourcePoolUri);

    let result = await this.appClient.exchange(
      CmdHelper.buildCmd2Url(this.appClient.c3BaseUri + "/" + DEPLOY_LIST_URI, this.config.resourcePoolUri),
      "get",
      null,
      HEADERS
    );

    return JSON.parse(result.body);
  }

  _saveList(deployList) {
    fs.writeFileSync(this.config.deployListFilePath, JSON.stringify(deployList, null, 2), "utf-8");

    console.log("> Deployment list saved to: " + this.config.deployListFilePath);
  }
}

module.exports = uuCloudDeployTask;
