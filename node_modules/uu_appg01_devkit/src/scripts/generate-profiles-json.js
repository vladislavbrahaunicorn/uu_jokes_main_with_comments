const fs = require("fs");
const path = require("path");
const paths = require("../config/paths.js");

module.exports = class GenerateProfilesJson {

  constructor(config) {
    this.config = config;
    this.debug = this.config.get("debug");
  }

  process() {
    let ProfileConfig;
    try {
      ProfileConfig = require("uu_appg01_workspace").ProfileConfig;
    } catch (e) {
      if (this.debug) {
        console.log("Warning: Library uu_appg01_workspace not found. Profiles.json will not be merged.", e);
      }
      return;
    }

    if (!ProfileConfig) {
      if (this.debug) {
        console.log("Warning: You are not using latest version of the uu_appg01_workspace. Profiles.json will not be merged.");
      }
      return;
    }

    console.log("Merging profiles.json of the application and libraries...");

    try {
      const mergerdProfiles = ProfileConfig.getMergedProfiles(true);

      if (!fs.existsSync(paths.buildDir)) {
        fs.mkdirSync(paths.buildDir);
      }
      let profilesPath = path.join(paths.buildDir, "profiles.json");
      fs.writeFileSync(profilesPath, JSON.stringify(mergerdProfiles, (k, v) => Array.isArray(v) ? JSON.stringify(v) : v, 2)
        .replace(/"\[/g, "[")
        .replace(/]"/g, "]")
        .replace(/\\"/g, "\"")
        .replace(/""/g, "\"")
        .replace(/","/g, "\", \""), "utf-8");

      console.log("> Merged Profiles.json saved to: " + profilesPath);
    } catch (e) {
      if (this.debug) {
        console.log("> Unable to merge profiles.json.", e);
      } else {
        console.log("> Unable to merge profiles.json."
          + "Merged configuration is for informational purposes only and has no effect on the build process. For more information about the error run this task with -- --debug parameter.");
      }
    }
  }

};
