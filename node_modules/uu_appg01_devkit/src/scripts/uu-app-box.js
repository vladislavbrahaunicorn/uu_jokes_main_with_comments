const fs = require("fs");
const path = require("path");
const shell = require("shelljs");

const paths = require("../config/paths.js");
const helpers = require("../tools/helpers.js");
const UuCloudConfig = require("./uu_cloud/uu-cloud-config.js");
const UuCloudLibraryConfig = require("./uu_cloud/uu-cloud-library-config.js");
const Package = require("uu_appg01_devkit-common/src/tools/package.js");

module.exports = class UuAppBox {

  constructor(config) {
    this.config = config;
  }

  async process() {
    // Ensure project is packaged before uploading to appbox
    shell.exec("npm run --loglevel=error package -- " + this.config.toCommandLineArgs().join(" ")); // TODO Escaping.
    Package.getSingletonSync("package.json").loadSync(); // reload as version might have changed

    let {name, version, dependencies, uuBuildSettings} = Package.getSingletonSync("package.json").get();
    let uuCloudConfig = null;
    let templateType = helpers.getTemplateInfo().type;
    if (templateType === "uu5-lib" || templateType === "lib") {
      uuCloudConfig = new UuCloudLibraryConfig(path.resolve("."), name, version, paths.buildDir, this.config, dependencies, uuBuildSettings);
    } else {
      uuCloudConfig = new UuCloudConfig(path.resolve("."), name, version, paths.buildDir, this.config);
    }

    const Task = require("./uu_cloud/task-app-box");
    await new Task(uuCloudConfig).process();
  }

};
