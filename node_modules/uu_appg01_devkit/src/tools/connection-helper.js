const Socket = require('net').Socket;

async function isServiceListening(port, host = '127.0.0.1') {
  return new Promise((resolve, reject) => {
    let socket = new Socket();
    socket.on('error', function () {
      resolve(false);
    });
    socket.connect(port, host, function () {
      socket.end();
      resolve(true);
    });
  });
}

async function findFreePort(port = 1024) {
  port = parseInt(port);
  while (await isServiceListening(port)) {
    port++;
    if (port > 65535) {
      throw new Error("No free port available");
    }
  }
  return port;
}

module.exports = {
  isServiceListening,
  findFreePort
};
