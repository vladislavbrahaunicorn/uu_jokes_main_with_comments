// workaround for pnpm which generates NODE_PATH into node_modules\.bin\*.cmd files (without it the resolving of files behaves differently
// when run via "npm test" vs. Jest in IDE "node node_modules\...\jest-cli\bin\jest.js"

const Module = require("module").Module;
if (Module && Module._initPaths) {
  const fs = require("fs");
  const path = require("path");

  let binFileName = path.join("node_modules", ".bin", "uu_appg01_devkit" + (process.platform === "win" ? ".cmd" : ""));
  if (fs.existsSync(binFileName)) {
    let binContent = fs.readFileSync(binFileName, "utf-8");
    let parts = binContent.split(/\bNODE_PATH\s*=/);
    if (parts.length > 1) {
      let nodePath;
      parts.slice(-1)[0].replace(/"[^"]*"|'[^']*'|\S*/, m => {
        nodePath = m.charAt(0).match(/['"]/) ? m.substr(1, m.length - 2) : m;
      });
      if (nodePath) {
        // https://stackoverflow.com/questions/21358994/node-js-programmatically-setting-node-path
        process.env.NODE_PATH = nodePath;
        Module._initPaths();
      }
    }
  }
}
