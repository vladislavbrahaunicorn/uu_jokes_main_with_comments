const DefaultReporter = require("@jest/reporters/build/default_reporter.js").default;

const MAX_FAILURE_TOTAL_LINES = 1000;

module.exports = class LimitedReporter extends DefaultReporter {
  constructor(...args) {
    super(...args);
    this._failureLines = 0;
    this._failuresCropped = false;
  }
  onRunComplete(...args) {
    if (this._failuresCropped)
      this.log("Some failure messages were omitted to limit console output. See test report for full data.");
    return super.onRunComplete(...args);
  }
  printTestFileFailureMessage(testPath, config, result) {
    if (result.failureMessage) {
      if (this._failureLines >= MAX_FAILURE_TOTAL_LINES) {
        result = { ...result, failureMessage: "" };
        this._failuresCropped = true;
      } else {
        this._failureLines += result.failureMessage.split(/\n/).length;
      }
    }
    return super.printTestFileFailureMessage(testPath, config, result);
  }
};
