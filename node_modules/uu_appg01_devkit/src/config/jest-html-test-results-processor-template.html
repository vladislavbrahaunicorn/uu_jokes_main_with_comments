<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1">
  <title>Test Results</title>

  <script>
    if (!location.href.match(/^(about:|file:)/)) {
      var bplCookie = document.cookie.match(/(^|;\s*)uu\.app\.bpl=([^;]+)/);
      var bplSegmentCount = (bplCookie ? Number(bplCookie[2]) : null);
      if (typeof bplSegmentCount !== "number" || isNaN(bplSegmentCount) || bplSegmentCount < 0) bplSegmentCount = 2;
      var appBaseUrlPath = (location.pathname.split(/\//).slice(0,1+bplSegmentCount).join("/")+"/").replace(/\/+/g,"/").replace(/"/g,"");
      var appAssetsRelativeUrlPath = "public/0.0.0/";
      document.write('<base href="' + appBaseUrlPath + appAssetsRelativeUrlPath + '" data-uu-app-base="' + appBaseUrlPath + '" data-uu-app-assets-base="' + appAssetsRelativeUrlPath + '">');
    }
  </script>

  <script src="https://cdn.plus4u.net/libs/systemjs/0.19.47/system.js"></script>

  <script>
    SystemJS.config({
      "paths": {
        "systemjs": "https://cdn.plus4u.net/libs/systemjs/0.19.47/system.js",
        "react": "https://cdn.plus4u.net/libs/react/16.13.1/react.js",
        "react-dom": "https://cdn.plus4u.net/libs/react-dom/16.13.1/react-dom.js",
        "create-react-class": "https://cdn.plus4u.net/libs/create-react-class/15.6.3/create-react-class.js",
        "prop-types": "https://cdn.plus4u.net/libs/prop-types/15.7.2/prop-types.js",

        "uu5g04": "https://cdn.plus4u.net/uu-uu5g04/1.0.0/uu5g04.min.js",
        "uu5g04-bricks": "https://cdn.plus4u.net/uu-uu5g04/1.0.0/uu5g04-bricks.min.js",
        "uu5g04-forms": "https://cdn.plus4u.net/uu-uu5g04/1.0.0/uu5g04-forms.min.js",
      }
    });

    var UU5 = {
      Environment: {
      }
    };

    // example test result value so that this template can be opened as-is and work fine
    var exampleTestData = {"numFailedTestSuites":1,"numFailedTests":1,"numPassedTestSuites":0,"numPassedTests":1,"numPendingTestSuites":0,"numPendingTests":1,"numRuntimeErrorTestSuites":0,"numTotalTestSuites":1,"numTotalTests":3,"snapshot":{"added":0,"didUpdate":false,"failure":false,"filesAdded":0,"filesRemoved":0,"filesUnmatched":0,"filesUpdated":0,"matched":0,"total":0,"unchecked":0,"uncheckedKeys":[],"unmatched":0,"updated":0},"startTime":1523555049388,"success":false,"testResults":[{"console":null,"failureMessage":"\u001b[1m\u001b[31m  \u001b[1m● \u001b[1mdescribed section › failing test\u001b[39m\u001b[22m\n\n    \u001b[2mexpect(\u001b[22m\u001b[31mreceived\u001b[39m\u001b[2m).toBe(\u001b[22m\u001b[32mexpected\u001b[39m\u001b[2m) // Object.is equality\u001b[22m\n    \n    Expected value to be:\n      \u001b[32m\"b\"\u001b[39m\n    Received:\n      \u001b[31m\"a\"\u001b[39m\n\u001b[2m\u001b[22m\n\u001b[2m    \u001b[0m \u001b[90m  5 | \u001b[39mdescribe(\u001b[32m\"described section\"\u001b[39m\u001b[33m,\u001b[39m () \u001b[33m=>\u001b[39m {\u001b[0m\u001b[22m\n\u001b[2m    \u001b[0m \u001b[90m  6 | \u001b[39m  test(\u001b[32m\"failing test\"\u001b[39m\u001b[33m,\u001b[39m () \u001b[33m=>\u001b[39m {\u001b[0m\u001b[22m\n\u001b[2m    \u001b[0m\u001b[31m\u001b[1m>\u001b[2m\u001b[39m\u001b[90m  7 | \u001b[39m    expect(\u001b[32m\"a\"\u001b[39m)\u001b[33m.\u001b[39mtoBe(\u001b[32m\"b\"\u001b[39m)\u001b[33m;\u001b[39m\u001b[0m\u001b[22m\n\u001b[2m    \u001b[0m \u001b[90m  8 | \u001b[39m  })\u001b[33m;\u001b[39m\u001b[0m\u001b[22m\n\u001b[2m    \u001b[0m \u001b[90m  9 | \u001b[39m\u001b[0m\u001b[22m\n\u001b[2m    \u001b[0m \u001b[90m 10 | \u001b[39m  test\u001b[33m.\u001b[39mskip(\u001b[32m\"skipped test\"\u001b[39m\u001b[33m,\u001b[39m () \u001b[33m=>\u001b[39m {\u001b[0m\u001b[22m\n\u001b[2m      \u001b[22m\n\u001b[2m      \u001b[2mat Object.<anonymous> (\u001b[2m\u001b[0m\u001b[36msrc/ttt.test.js\u001b[39m\u001b[0m\u001b[2m:7:17)\u001b[2m\u001b[22m\n","numFailingTests":1,"numPassingTests":1,"numPendingTests":1,"perfStats":{"end":1523555063412,"start":1523555053222},"snapshot":{"added":0,"fileDeleted":false,"matched":0,"unchecked":0,"unmatched":0,"updated":0,"uncheckedKeys":[]},"testFilePath":"C:\\Users\\milan\\git\\uu_uu5g04\\main\\src\\ttt.test.js","testResults":[{"ancestorTitles":[],"duration":4,"failureMessages":[],"fullName":"root test","location":null,"numPassingAsserts":0,"status":"passed","title":"root test"},{"ancestorTitles":["described section"],"duration":12,"failureMessages":["Error: \u001b[2mexpect(\u001b[22m\u001b[31mreceived\u001b[39m\u001b[2m).toBe(\u001b[22m\u001b[32mexpected\u001b[39m\u001b[2m) // Object.is equality\u001b[22m\n\nExpected value to be:\n  \u001b[32m\"b\"\u001b[39m\nReceived:\n  \u001b[31m\"a\"\u001b[39m\n    at Object.<anonymous> (C:\\Users\\milan\\git\\uu_uu5g04\\main\\src\\ttt.test.js:7:17)\n    at Object.asyncFn (C:\\Users\\milan\\git\\uu_uu5g04\\main\\node_modules\\jest-jasmine2\\build\\jasmine_async.js:82:37)\n    at resolve (C:\\Users\\milan\\git\\uu_uu5g04\\main\\node_modules\\jest-jasmine2\\build\\queue_runner.js:52:12)\n    at new Promise (<anonymous>)\n    at mapper (C:\\Users\\milan\\git\\uu_uu5g04\\main\\node_modules\\jest-jasmine2\\build\\queue_runner.js:39:19)\n    at promise.then (C:\\Users\\milan\\git\\uu_uu5g04\\main\\node_modules\\jest-jasmine2\\build\\queue_runner.js:73:82)\n    at <anonymous>\n    at process._tickCallback (internal/process/next_tick.js:188:7)"],"fullName":"described section failing test","location":null,"numPassingAsserts":0,"status":"failed","title":"failing test"},{"ancestorTitles":["described section"],"duration":0,"failureMessages":[],"fullName":"described section skipped test","location":null,"numPassingAsserts":0,"status":"pending","title":"skipped test"}],"sourceMaps":{},"skipped":false,"leaks":false}],"wasInterrupted":false};
  </script>

  <style type="text/css" data-uu-app-styles-insert-before>
    body {
      max-width: 1200px;
    }

    .passed {
      color: #6b9e42;
    }
    .passed-bg {
      background-color: #e0f2bf;
    }
    .failed {
      color: #dd283b;
    }
    .failed-bg {
      background-color: #ffbaba;
    }
    .skipped {
      color: #a0a0a0;
    }
    .skipped-bg {
      background-color: #f0f0f0;
    }

    .summary-item {
      display: flex;
    }
    .summary-item>* {
      flex: none;
    }
    .summary-item-title {
      font-weight: bold;
      min-width: 90px;
    }
    .summary-item>*:nth-child(n+3)::before {
      content: "\00a0/\00a0";
    }

    .test-suite {
      margin: 4px 0;
      line-height: normal;
    }
    .test-suite-summary {
      display: flex;
      padding: 0 5px;
      justify-content: flex-start;
      border-bottom: 1px solid #e0e0e0;
      font-weight: bold;
      cursor: pointer;
    }
    .test-suite-summary>* {
      flex: 0 0 100px;
      padding: 2px 5px;
      text-align: right;
    }
    .test-suite-summary>:first-child {
      flex: 1 0 auto;
      overflow: hidden;
      text-align: left;
      color: #000;
    }

    .test {
      padding: 2px 5px 2px 25px;
      border-bottom: 1px solid #e0e0e0;
      font-size: 90%;
    }
    .test-summary {
      font-weight: bold;
      cursor: pointer;
    }
    .test-messages {
      font-size: 90%;
      padding-left: 20px;
    }
  </style>

</head>
<body>
  <div id="renderHere"></div>

  <!--<script src="https://cdn.plus4u.net/uu-app-templateg01/1.0.0/in-browser-transpilation.min.js"></script>-->
  <script src="https://cdn.plus4u.net/uu-app-templateg01/1.0.0/in-browser-transpilation.js"></script>
  <script type="text/babel">
    import React, { useState, useEffect } from "react";
    import ReactDOM from "react-dom";
    import createReactClass from "create-react-class";
    import UU5 from "uu5g04";
    import "uu5g04-bricks";

    function stripAnsi(txt) {
      return txt.replace(/[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-PRZcf-nqry=><]/g, "");
    }

    const Test = createReactClass({
      mixins: [UU5.Common.BaseMixin, UU5.Common.ElementaryMixin],

      getInitialState() {
        return {
          opened: false
        };
      },
      _onClick(e) {
        e.stopPropagation();
        if (this.props.data.status === "failed") {
          this.setState(state => ({ opened: !state.opened }));
        }
      },
      render() {
        let { status, title, failureMessages, ancestorTitles } = this.props.data;
        return (
          <div className={`test ${status === "pending" ? "skipped skipped-bg" : status + " " + status + "-bg"}`}>
            <div className="test-summary" onClick={this._onClick}>
              {ancestorTitles.concat([title]).join(" / ")}
            </div>
            {this.state.opened && (
              <div>
                {failureMessages.map((it, idx) => <pre className="test-messages" key={idx}>{stripAnsi(it)}</pre>)}
              </div>
            )}
          </div>
        );
      }
    });

    const TestSuite = createReactClass({
      mixins: [UU5.Common.BaseMixin, UU5.Common.ElementaryMixin],

      getInitialState() {
        return {
          opened: false
        };
      },
      _onClick(e) {
        e.stopPropagation();
        this.setState(state => ({ opened: !state.opened }));
      },
      _getTestResults() {
        let { testResults } = this.props.data;
        let result;
        if (typeof testResults === "string") result = testResults ? JSON.parse(testResults) : [];
        else result = testResults;
        return result;
      },
      render() {
        let { numPassingTests, numFailingTests, numPendingTests, testFilePath, testResults } = this.props.data;
        return (
          <div className="test-suite">
            {this.props.showHeader && (
              <div className="test-suite-summary">
                <span>Test Suite</span>
                <span>Failed</span>
                <span>Skipped</span>
                <span>Passed</span>
              </div>
            )}
            <div
              className={`test-suite-summary ${numFailingTests && "failed failed-bg" || numPendingTests && "skipped skipped-bg" || "passed passed-bg"}`}
              onClick={this._onClick}
            >
              <span>{testFilePath}</span>
              <span>{numFailingTests}</span>
              <span>{numPendingTests}</span>
              <span>{numPassingTests}</span>
            </div>
            {this.state.opened && this._getTestResults().map((it, idx) => <Test key={idx} data={it} />)}
          </div>
        );
      }
    });

    const Summary = createReactClass({
      mixins: [UU5.Common.BaseMixin],

      render() {
        let { data } = this.props; // testResult object: https://facebook.github.io/jest/docs/en/configuration.html#testresultsprocessor-string
        let { numPassedTestSuites, numFailedTestSuites, numPendingTestSuites, numTotalTestSuites } = data;
        let { numPassedTests, numFailedTests, numPendingTests, numTotalTests } = data;
        let { snapshot, testResults, startTime } = data;
        let endTime = testResults.reduce((r, it) => Math.max(r, it.perfStats.end), 0);
        return (
          <UU5.Bricks.Section>
            <div className="summary-item">
              <span className="summary-item-title">Test suites:</span>
              {numTotalTestSuites && <span className="failed">{numFailedTestSuites} failed</span> || null}
              {numTotalTestSuites && <span className="skipped">{numPendingTestSuites} skipped</span> || null}
              {numTotalTestSuites && <span className="passed">{numPassedTestSuites} passed</span> || null}
              <span>{numTotalTestSuites} total</span>
            </div>
            <div className="summary-item">
              <span className="summary-item-title">Tests:</span>
              {numTotalTests && <span className="failed">{numFailedTests} failed</span> || null}
              {numTotalTests && <span className="skipped">{numPendingTests} skipped</span> || null}
              {numTotalTests && <span className="passed">{numPassedTests} passed</span> || null}
              <span>{numTotalTests} total</span>
            </div>
            <div className="summary-item">
              <span className="summary-item-title">Snapshots:</span>
              {snapshot.total && <span className="failed">{snapshot.unmatched} failed</span> || null}
              {snapshot.total && <span className="passed">{snapshot.matched} passed</span> || null}
              <span>{snapshot.total} total</span>
            </div>
            <div className="summary-item">
              <span className="summary-item-title">Time:</span>
              <span>{((endTime || startTime) - startTime) / 1000}s</span>
            </div>
          </UU5.Bricks.Section>
        );
      }
    });

    const _renderFilesInfo = function(filesMap) {
      let components = [];

      for (let fileName in filesMap) {
        components.push(
          <UU5.Bricks.Row>
            <UU5.Bricks.Column colWidth="xs-12 s-9">{fileName}</UU5.Bricks.Column>
            <UU5.Bricks.Column colWidth="xs-12 s-3">{filesMap[fileName]} times</UU5.Bricks.Column>
          </UU5.Bricks.Row>
        );
      }

      return components;
    };

    const SINGLE_BATCH_MAX_TIME = 10;
    const NEXT_BATCH_DELAY = 0;
    const useComplexComputation = (computationGeneratorFn, deps = []) => {
      let [result, setResult] = useState();
      let isComputing = result === undefined;
      useEffect(() => {
        let time = performance.now();
        let shouldPauseFn = () => performance.now() - time >= SINGLE_BATCH_MAX_TIME;
        let generator = computationGeneratorFn(shouldPauseFn);
        (async () => {
          let done, value, result;
          while (!({ done, value } = generator.next()).done) {
            result = value;
            await new Promise(resolve => setTimeout(resolve, NEXT_BATCH_DELAY));
            time = performance.now();
          }
          if (result === undefined) throw new Error("Complex computation didn't return any result. It must yield value that is not 'undefined'.")
          setResult(result);
        })();
        return () => generator.return();
      }, deps);
      return [result, isComputing];
    }

    const ErrorSet = ({ data }) => {
      let [result, isComputing] = useComplexComputation(function *(shouldPauseFn) {
        let errors = [];
        for (let results of data.testResults) {
          let testResults = typeof results.testResults === "string" ? JSON.parse(results.testResults) : results.testResults;
          if (shouldPauseFn()) yield;
          testResults
            .filter(item => item.status === "failed")
            .forEach(testResults => {
              errors = errors.concat(testResults.failureMessages.map(message => ({message, file: testResults.fullName })));
            });
        }
        if (shouldPauseFn()) yield;
        
        let errorSet = new Set();
        let errorMap = {};
        // only snapshot errors
        for (let {message, file} of errors) {
          let item = message;
          if (shouldPauseFn()) yield;
          let matches = stripAnsi(item).match(/(?:\n\s*(?:\+|-)[^\n]*)+(?:\n|$)/g);
          if (matches){
            matches.map(item => item.trim().replace(/(^|\n)\s*([-+])\s+/g, "$1$2 ")).
            filter(item => item !== "- Snapshot\n+ Received" && item !== "- Expected\n+ Received").
            forEach(item => { 
              errorSet.add(item); 
              errorMap[item] = errorMap[item] || { count: 0 };
              errorMap[item].count++;
              if (errorMap[item][file]) {
                errorMap[item][file]++;
              } else {
                errorMap[item][file] = 1;
              }
            })
          }
        }

        yield { errorSet, errorMap };
      }, [data]);

      let components = [];
      if (isComputing) {
        components.push(<UU5.Bricks.Loading />);
      } else if (result.errorSet.size) {
        let {errorSet, errorMap} = result;
        errorSet.forEach((error, index) => {
          let {count, ...errorFiles} = errorMap[error];
          components.push(
            <UU5.Bricks.Panel
              header={(
                <UU5.Bricks.Row>
                  <UU5.Bricks.Column colWidth="xs-12 s-9"><pre>{error}</pre></UU5.Bricks.Column>
                  <UU5.Bricks.Column colWidth="xs-12 s-3">{count} times</UU5.Bricks.Column>
                </UU5.Bricks.Row>
              )} 
              key={index}
              className={UU5.Common.Css.css(" margin: 16px; .uu5-bricks-panel-header-content { display: block; width: 100%; }")}
            >
              {_renderFilesInfo(errorFiles)}
            </UU5.Bricks.Panel>
          );
        });
      } else {
        components.push("No snapshot errors");
      }

      return (
        <UU5.Bricks.Section>
          {components}
        </UU5.Bricks.Section>
      );
    };

    const Page = createReactClass({
      mixins: [UU5.Common.BaseMixin],

      render() {
        let { data } = this.props; // testResult object: https://facebook.github.io/jest/docs/en/configuration.html#testresultsprocessor-string
        return (
          <UU5.Bricks.Page>
            <Summary data={data} />
            <UU5.Bricks.Section>
              {data.testResults.map((it, idx) => <TestSuite key={idx} data={it} showHeader={idx === 0}/>)}
            </UU5.Bricks.Section>
            <ErrorSet data={data} />
          </UU5.Bricks.Page>
        );
      }
    });

    ReactDOM.render(<UU5.Bricks.Loading />, document.getElementById('renderHere'));

    setTimeout(() => {
      let data = document.querySelector("test-data").childNodes[0].data;
      if (data.charAt(0) === "$") data = exampleTestData;
      else data = JSON.parse(data.replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&amp;/g, "&"));
      window.testResult = data;
      ReactDOM.render(<Page data={data} />, document.getElementById('renderHere'));
    }, 0);
  </script>
  <test-data style="display: none;"><!--$testResultHtml$--></test-data>
</body>
</html>
