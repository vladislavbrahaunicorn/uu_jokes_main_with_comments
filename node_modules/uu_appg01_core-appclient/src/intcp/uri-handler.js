"use strict";

const { Config, OptsReader } = require("uu_appg01_core-utils");

/**
 * Interceptor for finalizing uuUri URL in case it's incomplete (missing gateway).
 */
class UriHandler {
  constructor(next, options = null) {
    this._next = next;
    this._options = options;
  }

  async invoke(request, options = null) {
    let uri = "";
    let ucUri = (request.uri || "").toString();
    if (!ucUri.match(/^https?:/i)) {
      let opts = new OptsReader(options, this._options);
      let baseUri = opts.getString("baseUri");
      if (!baseUri || !baseUri.match(/^https?:/i)) {
        opts = new OptsReader(options, this._options, Config);
        let gatewayUri = opts.getString("gatewayUri", "https://uuappg01.plus4u.net");
        uri += `${gatewayUri.replace(/\/$/, "")}/`;
      }
      if (baseUri) {
        uri += `${baseUri.replace(/^\/|\/$/g, "")}/`;
      }
      uri += ucUri.replace(/^\//, "");
    } else {
      uri += ucUri;
    }
    request.uri = uri;
    return this._next.invoke(request, options);
  }
}

module.exports = UriHandler;
