"use strict";

const { Perflog } = require("uu_appg01_core-perflog");

/**
 * Interceptor for performance logging.
 */
class PerfLogHandler {
  constructor(next, options = null) {
    this._next = next;
  }

  async invoke(request, options = null) {
    let next = this._next;
    let promise;
    Perflog.measureSection("UU_APP_CLIENT_REQUEST", function(section) {
      request.headers["x-request-id"] = section.getId().toString();
      let uri = request.uri.toString().replace(/access_token=[^&]+/, "access_token=hidden");
      section.setAttribute("uri", uri);
      promise = next.invoke(request, options);
    });
    return promise;
  }
}

module.exports = PerfLogHandler;
